import express from "express";
import fetch from "node-fetch";
import dotenv from "dotenv";
import { signTencentCloud } from "./tencentSign.js";

dotenv.config();

const app = express();
app.use(express.json());

// æäº¤3Dç”Ÿæˆä»»åŠ¡
app.post('/generate-3d', async (req, res) => {
    try {
        const { prompt } = req.body;
        
        const host = "ai3d.tencentcloudapi.com";  // âœ… æ­£ç¡®çš„æœåŠ¡
        const service = "ai3d";  // âœ… æ­£ç¡®çš„æœåŠ¡å
        const action = "SubmitHunyuanTo3DProJob";  // âœ… æ­£ç¡®çš„ Action
        const version = "2025-05-13";  // âœ… æ­£ç¡®çš„ç‰ˆæœ¬
        const region = "ap-guangzhou";
        
        // æ ¹æ®APIæ–‡æ¡£æ„å»ºè¯·æ±‚å‚æ•°
        const payload = JSON.stringify({
            Prompt: prompt,
            // å¯èƒ½è¿˜éœ€è¦å…¶ä»–å‚æ•°,å‚è€ƒæ–‡æ¡£
        });
        
        const { authorization, timestamp } = signTencentCloud({
            secretId: process.env.TENCENTCLOUD_SECRET_ID,
            secretKey: process.env.TENCENTCLOUD_SECRET_KEY,
            service,
            host,
            payload
        });
        
        const response = await fetch(`https://${host}`, {
            method: "POST",
            headers: {
                "Authorization": authorization,
                "Content-Type": "application/json; charset=utf-8",
                "Host": host,
                "X-TC-Action": action,
                "X-TC-Version": version,
                "X-TC-Region": region,
                "X-TC-Timestamp": timestamp.toString()
            },
            body: payload
        });
        
        const data = await response.json();
        console.log("âœ… æäº¤ä»»åŠ¡å“åº”:", JSON.stringify(data, null, 2));
        
        if (data.Response && data.Response.JobId) {
            res.json({
                success: true,
                jobId: data.Response.JobId
            });
        } else if (data.Response && !data.Response.Error) {
            res.json({
                success: true,
                data: data.Response
            });
        } else {
            res.json({
                success: false,
                error: data.Response?.Error?.Message || "æœªçŸ¥é”™è¯¯",
                code: data.Response?.Error?.Code,
                raw: data
            });
        }
    } catch (error) {
        console.error("âŒ é”™è¯¯:", error);
        res.json({ 
            success: false, 
            error: error.message 
        });
    }
});

// æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ (æ ¹æ®æ–‡æ¡£å¯èƒ½éœ€è¦ä¸åŒçš„ Action)
app.get('/query-3d/:jobId', async (req, res) => {
    try {
        const { jobId } = req.params;
        
        const host = "ai3d.tencentcloudapi.com";
        const service = "ai3d";
        const action = "QueryHunyuanTo3DProJob";  // æŸ¥è¯¢æ¥å£ (å¯èƒ½éœ€è¦æ ¹æ®æ–‡æ¡£è°ƒæ•´)
        const version = "2025-05-13";
        const region = "ap-guangzhou";
        
        const payload = JSON.stringify({
            JobIds: [jobId]
        });
        
        const { authorization, timestamp } = signTencentCloud({
            secretId: process.env.TENCENTCLOUD_SECRET_ID,
            secretKey: process.env.TENCENTCLOUD_SECRET_KEY,
            service,
            host,
            payload
        });
        
        const response = await fetch(`https://${host}`, {
            method: "POST",
            headers: {
                "Authorization": authorization,
                "Content-Type": "application/json; charset=utf-8",
                "Host": host,
                "X-TC-Action": action,
                "X-TC-Version": version,
                "X-TC-Region": region,
                "X-TC-Timestamp": timestamp.toString()
            },
            body: payload
        });
        
        const data = await response.json();
        console.log("âœ… æŸ¥è¯¢ä»»åŠ¡å“åº”:", JSON.stringify(data, null, 2));
        
        if (data.Response) {
            res.json({
                success: true,
                status: data.Response.JobStatusMsg || data.Response.Status,
                progress: data.Response.JobProgress || data.Response.Progress,
                modelUrl: data.Response.ResultObjUrl || data.Response.ModelUrl,
                data: data.Response
            });
        } else {
            res.json({
                success: false,
                error: "æŸ¥è¯¢å¤±è´¥",
                raw: data
            });
        }
    } catch (error) {
        console.error("âŒ é”™è¯¯:", error);
        res.json({ 
            success: false, 
            error: error.message 
        });
    }
});

app.listen(3000, () => {
    console.log('âœ… Server running on http://127.0.0.1:3000');
    console.log('ğŸ“ æœåŠ¡é…ç½®:');
    console.log('   - Service: ai3d');
    console.log('   - Action: SubmitHunyuanTo3DProJob');
    console.log('   - Version: 2025-05-13');
});